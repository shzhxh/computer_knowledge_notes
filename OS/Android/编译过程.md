### 参考

[理解安卓build系统](https://www.ibm.com/developerworks/cn/opensource/os-cn-android-build/)

### source build/envsetup.sh

初始化编译环境，并引入一些辅助命令。

- 1~29, hmm, 加载编译时使用的命令。

- 214~222, printconfig, 显示当前构建的配置信息。

- 439~460, add_lunch_combo, 用来给lunch命令添加编译选项。

  脚本里添加了6条选项：

  ```
  add_lunch_combo aosp_arm-eng
  add_lunch_combo aosp_arm64-eng
  add_lunch_combo aosp_mips-eng
  add_lunch_combo aosp_mips64-eng
  add_lunch_combo aosp_x86-eng
  add_lunch_combo aosp_x86_64-eng
  ```

- 659~668, m, 在源码树的根目录执行make

- 687~723, mm, 构建当前目录下的模块

- 725～770， mmm, 构建指定目录下的模块

- 823～831，croot，切换到源码树的根的目录

- 1329~1332, jgrep, 在所有java文件上执行grep

- 1334~1337, cgrep, 在所有c/c++文件上执行grep

- 1339~1342, resgrep, 在所有res/*.xml文件上执行grep

- 1590~1632, godir, 转到包含某个文件的目录路径

- 1738~1747，在文件的末尾，查找vendorsetup.sh脚本并加载它。

  可以单独运行find命令找到这些脚本的位置，它们在device/generic/x86/vendorsetup.sh和device/generic/x86_64/vendorsetup.sh。它们只有3条命令，以device/generic/x86/vendorsetup.sh为例：

  ```
  add_lunch_combo android_x86-eng
  add_lunch_combo android_x86-userdebug
  add_lunch_combo android_x86-user
  ```


### lunch

lunch命令定义在build/envsetup.sh里，用来让用户选择编译设备与编译类型。其执行步骤如下：

1. 定义变量answer，如果命令里给了参数则直接使用给定的参数，否则列出所有的编译选项让用户选项。

2. 定义变量selection，如果用户没选择则使用默认选项aosp_arm-eng，如果用户输入的是数字则使用该数字对应的字符串，如果用户输入的是字符串则直接使用该字符串。

3. 定义变量product，将selection里"-"的前面部分放在变量product里，调用check_product函数检查之。

4. 定义变量variant，将selection里"-"的后面部分放在变量variant里，调用check_variant函数检查之。

5. 定义如下3个环境变量

   ```
   export TARGET_PRODUCT=$product
   export TARGET_BUILD_VARIANT=$variant
   export TARGET_BUILD_TYPE=release
   ```

6. set_stuff_for_environment函数，设置一些环境变量。

7. printconfig函数，打印一些主要的变量。

### make

如果没有指定编译目标，则使用默认目标**droid**，该目标会编译出完整的安卓镜像。

#### build系统核心文件

位于`build/core`目录下

#### 针对具体产品的makefile

通常位于`device`目录下

#### 针对某个模块的makefile

这类文件的名称都叫做`Android.mk`

### 编译出的结果

在`out`目录下