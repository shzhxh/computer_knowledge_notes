#### step1: boot rom

执行固化在rom中的指令，把boot loader加载到内存，跳转到boot loader继续执行。

#### step2: boot loader

源代码在bootable目录。也是OEM厂商或运营商加锁和限制的地方。分为两个阶段。

第一阶段：检测ram，加载第二阶段的程序。

第二阶段：设置网络，内存等。

#### step3: Linux kernel

源代码在kernel目录。内核启动时，设置缓存、被保护存储器、计划列表，加载驱动。当内核完成系统设置，它首先在系统文件中寻找”init”文件，然后启动root进程或者系统的第一个进程。

- init/main.c : start_kernel

- init/main.c : rest_init

- init/main.c : kernel_init

  `ramdisk_execute_command`是内核参数`rdinit`的值，默认为`/init`

- init/main.c : run_init_process

  执行`kernel_execve`函数，转到用户态执行init进程。

#### step4: init process

源代码在system/core/init/init.c，init.rc在system/core/rootdir/init.rc。

init是第一个进程，也叫root进程或所有进程的父进程。在此阶段可以看到屏幕上的"Android" Logo。

init进程的职责：

1. 挂载目录，比如/sys, /dev, /porc。

2. 运行init.rc脚本。脚本语言的介绍详见system/core/init/README.md。

3. 作为守护进程。

4. 属性服务。

5. 处理子进程终止。

   详见`queue_builtin_action(signal_init_action, "signal_init")`

源码分析：

- system/core/init/init.c : main

  如果第1个参数是ueventd，则执行`ueventd_main`，冷插拔进程。

  如果第1个参数是watchdogd，则执行`watchdogd_main`，看门狗进程。

  `umask(0)`设置文件权限的掩码为0。

  先建立基本的目录结构，再在随后的rc文件里建立其它的目录结构。`mount`的第一个参数是源，第二个参数是目标目录，第三个参数是文件系统类型，第四个参数是读写标记，第五个参数是个void指针。tmpfs是内存中的文件系统，读写速度快。proc是内存中内核的数据结构。devpts是虚拟的中断文件系统。sysfs是把proc, devfs, devpts统一起来。

  不能在根目录上为kmsg和null创建设备节点，否则就没法在随后将根目录重新挂载为只读了。所以要挂载到/dev目录。open_devnull_stdio屏蔽了init进程的标准输入输出信息，要用klog_init函数输出log信息。property_init是开辟了一块全局共享内存，这样所有进程就可以共享这块内存里的属性设置了。

  get_hardware_name通过读proc文件系统来获取硬件的相关信息。

  process_kernel_cmdline。

  selinux是一种安全机制，此处实现了日志信息的回调函数到内核实现。

  restorecon。

  bootmode是个全局静态变量，用来标示启动模式，android的启动模式分为正常开机流程和关机充电流程。

  init_parse_config_file用于解析rc配置文件。

  action_for_each_trigger遍历从rc文件得到的action_list链表，将满足触发器的动作添加到action_queue中。一个action结构体包含4个链表，一个是所有动作的链表，一个是执行队列中动作的链表，一个是触发器对应的动作的链表，一个是命令的链表。

  在事件循环里接收SIGCHLD信号，进而通过handle_signal执行wait_for_process函数，完成进程资源回收或进程重启工作。

#### step5: Zygote

源代码在frameworks/base/core/java/com/android/internal/os/ZygoteInit.java

Zygote是一个虚拟机进程，由init进程启动。Zygote预加载以及初始化核心库类。

在此阶段可以看到启动画面。

#### step6: System Servers

Zygote启动系统服务，即ZygoteInit类里的startSystemServer方法。

#### step7: 引导完成

系统服务运行起来后，引导完成，此时会发送开机启动广播`ACTION_BOOT_COMPLETED`

#### 附录：Android Init Language

详见：system/core/init/README.md

由五类语句构成：Actions, Commands, Services, Options and Imports.从整体来看，一个rc文件就是由一串动作加一串服务组成的，动作或服务都是由命令和选项组成的。服务的名称必须是唯一的。

##### .rc文件

init language用在.rc文件中，它可能出现在系统中的多个位置。

- /init.rc是最初的.rc文件，它会随着init的执行而执行，用于系统的最初设置。

##### Actions

Actions就是触发器加一串命令，触发器用来决定是否执行一个Action。如果满足了触发器的条件且action还不在运行队列里，则这个action会被加到运行队列的尾部。

运行的格式如下：

```
on <trigger> [&& <trigger>]*
  <command>
  <command>
```

##### Services

Services是程序，它由init进程启动，并且可以退出后重启(可选)。

服务的格式如下：

```
service <name> <pathname> [<argument> ]*
  <option>
  <option>
```

##### Options

Options是Services的修改器，它们影响init进程如何运行service以及何时运行service。

- console，此服务需要一个console。默认设备为`/dev/console`。也可自己指定，如`console /dev/tty0`，其中`/dev/`是可忽略的，即等同于`console tty0`。
- ctitical，此服务是一个设备关键服务。如果在4分钟内退出4次，设备将会重启进入recovery模式。
- disabled，此服务无法通过它的类来启动，必须通过它的名字来启动。
- setenv，在启动的进程里设置环境变量。
- socket，创建一个unix域socket，并将它的fd传给启动的进程。
- file，打开一个文件并将它的fd传给启动的进程。
- user，在执行服务前改变用户名。
- group，在执行服务前改变组名。
- capabilities，在执行服务的时候设置capabilities.
- seclabel，在执行服务前改变为seclabel。
- oneshot，当服务退出后不要重启它。
- class，为服务指定类名。
- animation，将会包含所有启动和关闭animation所必须的服务。
- onrestart当服务重启的时候执行一条命令。
- writepid，当子进程forks的时候将其pid写到给定文件中。
- priority，调度service进程的优先级。
- namespace，当forking一个服务的时候，进入一个新的PID或挂载namespace。
- oom_score_adjust，设置子进程的变量值。
- memcg.swappiness，设置子进程的变量值。
- memcg.soft_limit_in_bytes，设置子进程的变量值。
- memcg.limit_in_bytes，设置子进程的变量值。
- shutdown，设置关机的时候此service进程的行为。默认是关机进程通过传递SIGTERM和SIGKILL来杀死此服务。

##### Triggers

Triggers就是个字符串，用来匹配特定事件和触发一个action。分为事件触发器和权限触发器。

事件触发器就是个简单的字符串，如"boot"或"late-init"。

权限触发器就是个键值对，其格式为`property:<name>=<value>`。

一个动作可以有多个权限触发器但只能有一个事件触发器。

##### Commands

`bootchart [start|stop]`

> Start/stop bootcharting. These are present in the default init.rc files,
> but bootcharting is only active if the file /data/bootchart/enabled exists;
> otherwise bootchart start/stop are no-ops.

`chmod <octal-mode> <path>`
> Change file access permissions.

`chown <owner> <group> <path>`
> Change file owner and group.

`class_start <serviceclass>`
> Start all services of the specified class if they are
> not already running.  See the start entry for more information on
> starting services.

`class_stop <serviceclass>`
> Stop and disable all services of the specified class if they are
> currently running.

`class_reset <serviceclass>`
> Stop all services of the specified class if they are
> currently running, without disabling them. They can be restarted
> later using `class_start`.

`class_restart <serviceclass>`
> Restarts all services of the specified class.

`copy <src> <dst>`
> Copies a file. Similar to write, but useful for binary/large
> amounts of data.
> Regarding to the src file, copying from symbolic link file and world-writable
> or group-writable files are not allowed.
> Regarding to the dst file, the default mode created is 0600 if it does not
> exist. And it will be truncated if dst file is a normal regular file and
> already exists.

`domainname <name>`
> Set the domain name.

`enable <servicename>`
> Turns a disabled service into an enabled one as if the service did not
> specify disabled.
> If the service is supposed to be running, it will be started now.
> Typically used when the bootloader sets a variable that indicates a specific
> service should be started when needed. E.g.
>
>    on property:ro.boot.myfancyhardware=1
> ​       enable my_fancy_service_for_my_fancy_hardware
> ​       

`exec [ <seclabel> [ <user> [ <group>\* ] ] ] -- <command> [ <argument>\* ]`

> Fork and execute command with the given arguments. The command starts
> after "--" so that an optional security context, user, and supplementary
> groups can be provided. No other commands will be run until this one
> finishes. _seclabel_ can be a - to denote default. Properties are expanded
> within _argument_.
> Init halts executing commands until the forked process exits.

`exec_start <service>`
> Start a given service and halt the processing of additional init commands
> until it returns.  The command functions similarly to the `exec` command,
> but uses an existing service definition in place of the exec argument vector.

`export <name> <value>`
> Set the environment variable _name_ equal to _value_ in the
> global environment (which will be inherited by all processes
> started after this command is executed)

`hostname <name>`
> Set the host name.

`ifup <interface>`
> Bring the network interface _interface_ online.

`insmod [-f] <path> [<options>]`
> Install the module at _path_ with the specified options.
> -f: force installation of the module even if the version of the running kernel
> and the version of the kernel for which the module was compiled do not match.

`load_all_props`
> Loads properties from /system, /vendor, et cetera.
> This is included in the default init.rc.

`load_persist_props`
> Loads persistent properties when /data has been decrypted.
> This is included in the default init.rc.

`loglevel <level>`
> Sets the kernel log level to level. Properties are expanded within _level_.

`mkdir <path> [mode] [owner] [group]`
> Create a directory at _path_, optionally with the given mode, owner, and
> group. If not provided, the directory is created with permissions 755 and
> owned by the root user and root group. If provided, the mode, owner and group
> will be updated if the directory exists already.

`mount <type> <device> <dir> [ <flag>\* ] [<options>]`

> Attempt to mount the named device at the directory _dir_
> _flag_s include "ro", "rw", "remount", "noatime", ...
> _options_ include "barrier=1", "noauto\_da\_alloc", "discard", ... as
> a comma separated string, eg: barrier=1,noauto\_da\_alloc

`restart <service>`
> Stops and restarts a running service, does nothing if the service is currently
> restarting, otherwise, it just starts the service.

`restorecon <path> [ <path>\* ]`
> Restore the file named by _path_ to the security context specified
> in the file\_contexts configuration.
> Not required for directories created by the init.rc as these are
> automatically labeled correctly by init.

`restorecon_recursive <path> [ <path>\* ]`
> Recursively restore the directory tree named by _path_ to the
> security contexts specified in the file\_contexts configuration.

`rm <path>`
> Calls unlink(2) on the given path. You might want to
> use "exec -- rm ..." instead (provided the system partition is
> already mounted).

`rmdir <path>`
> Calls rmdir(2) on the given path.

`setprop <name> <value>`
> Set system property _name_ to _value_. Properties are expanded
> within _value_.

`setrlimit <resource> <cur> <max>`
> Set the rlimit for a resource.

`start <service>`
> Start a service running if it is not already running.
> Note that this is _not_ synchronous, and even if it were, there is
> no guarantee that the operating system's scheduler will execute the
> service sufficiently to guarantee anything about the service's status.

> This creates an important consequence that if the service offers
> functionality to other services, such as providing a
> communication channel, simply starting this service before those
> services is _not_ sufficient to guarantee that the channel has
> been set up before those services ask for it.  There must be a
> separate mechanism to make any such guarantees.

`stop <service>`

> Stop a service from running if it is currently running.

`swapon_all <fstab>`
> Calls fs\_mgr\_swapon\_all on the given fstab file.

`symlink <target> <path>`
> Create a symbolic link at _path_ with the value _target_

`sysclktz <mins_west_of_gmt>`
> Set the system clock base (0 if system clock ticks in GMT)

`trigger <event>`
> Trigger an event.  Used to queue an action from another
> action.

`umount <path>`
> Unmount the filesystem mounted at that path.

`verity_load_state`
> Internal implementation detail used to load dm-verity state.

`verity_update_state <mount-point>`
> Internal implementation detail used to update dm-verity state and
> set the partition._mount-point_.verified properties used by adb remount
> because fs\_mgr can't set them directly itself.

`wait <path> [ <timeout> ]`
> Poll for the existence of the given file and return when found,
> or the timeout has been reached. If timeout is not specified it
> currently defaults to five seconds.

`wait_for_prop <name> <value>`
> Wait for system property _name_ to be _value_. Properties are expanded
> within _value_. If property _name_ is already set to _value_, continue
> immediately.

`write <path> <content>`
> Open the file at _path_ and write a string to it with write(2).
> If the file does not exist, it will be created. If it does exist,
> it will be truncated. Properties are expanded within _content_.

##### Imports

解析init配置文件，扩展当前配置。